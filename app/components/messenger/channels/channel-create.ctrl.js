'use strict';

app.controller('createChannelController', ['$scope', '$uibModalInstance',
  '$log',
  'channelsService', 'Channel', 'ArrayUtil', 'CurrentMember', 'Team',
  'channelsNumber',
  function ($scope, $uibModalInstance, $log, channelsService, Channel,
    ArrayUtil, CurrentMember, Team, channelsNumber) {
    $scope.forms = {};
    $scope.newChannel = {};
    $scope.channelsNumber = channelsNumber;
    $scope.teamMembers = [];
    var selectedMembers = [];

    var makeSelectedMembersArray = function () {
      selectedMembers = [];
      selectedMembers.push(CurrentMember.member.id.toString());
      for (var i = 0; i < $scope.teamMembers.length; i++) {
        if ($scope.teamMembers[i].selected === true)
          selectedMembers.push($scope.teamMembers[i].id.toString());
      }
    };

    $scope.formNameCheckEmpty = function (form) {
      return ((form.name.$touched || form.$submitted) && (!form.name.$viewValue));
    };

    $scope.formNameCheckMax = function (form) {
      return (form.name.$viewValue && form.name.$invalid);
    };


    $scope.closeCreateChannel = function () {
      $uibModalInstance.close();
    };

    $scope.createChannelSubmit = function () {
      $scope.newChannel.serverError = false;
      if ($scope.forms.newChannelForm.$valid === true) {
        sendNewChannelData();
      }
    };

    $scope.teamMemberClick = function (teamMember) {
      teamMember.selected = !teamMember.selected;
    };

    $scope.getCssClass = function (teamMember) {
      if (teamMember.selected)
        return 'selected';
      else
        return 'selectable';
    };

    var sendNewChannelData = function () {
      makeSelectedMembersArray();
      var newChannelType = $scope.newChannel.isPrivate ?
        Channel.TYPE.PRIVATE : Channel.TYPE.PUBLIC;
      var newChannelData = {
        name: $scope.newChannel.name,
        description: $scope.newChannel.description,
        type: newChannelType,
        member_ids: selectedMembers,
        creator: CurrentMember.member.id,
        team: Team.id
      };
      channelsService.createChannel(newChannelData)
        .then(function () {
          $scope.closeCreateChannel();
        })
        .catch(function (err) {
          if (err.indexOf('Team reached channels limit.') != -1) {
            $log.error('Error Creating new Channel:', err);
            $scope.newChannel.limitError = true;
          }
          if (err.indexOf('Duplicate slug in team.') != -1) {
            $log.error('Error Creating new Channel:', err);
            $scope.newChannel.dublicateError = true;
          } else {
            $scope.newChannel.serverError = true;
          }
        });
    };

    function makeTeamMembersArray() {
      Team.getActiveMembers().forEach(function (member) {
        $scope.teamMembers.push(member);
        member.selected = false;
      });
      ArrayUtil.removeElementByKeyValue($scope.teamMembers,
        'id', CurrentMember.member.id);
    }

    angular.element(document).ready(function () {
      initializeNewChannelForm();
    });

    var initializeNewChannelForm = function () {
      $scope.newChannel.name = '';
      $scope.newChannel.description = '';
      $scope.newChannel.isPrivate = false;
      $scope.newChannel.limitError = false;
      $scope.newChannel.dublicateError = false;
      $scope.newChannel.serverError = false;
      $scope.forms.newChannelForm.$setPristine();
      makeTeamMembersArray();
    };
  }
]);
