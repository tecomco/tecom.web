"use strict";var app=angular.module("tecomApp",["ui.router","ngStorage","angular-jwt","ui.bootstrap","config","ngFileUpload","ngSanitize","mwl.confirm","ngMessages","angular-web-notification","ngProgress","bm.uiTour"]);app.config(["$httpProvider","jwtOptionsProvider","$localStorageProvider",function(a,b,c){b.config({tokenGetter:function(){return c.get("token")}}),a.interceptors.push("jwtInterceptor")}]),app.config(["$httpProvider","jwtInterceptorProvider",function(a,b){b.authPrefix="JWT "}]),app.config(["TourConfigProvider",function(a){a.set("scrollIntoView",!1),a.set("backdropBorderRadius",5),a.set("useHotkeys",!0)}]),app.run(["$rootScope","$timeout",function(a,b){a.isLoading=!0,a.socketConnected=!0,a.hasUnread=!1,a.isLoadingTakingTooLong=!1,b(function(){a.isLoadingTakingTooLong=!0},1e4)}]),app.config(["$locationProvider",function(a){a.html5Mode(!0)}]),app.config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/messenger/"),a.state("messenger",{abstract:!0,url:"/messenger",views:{"":{templateUrl:"app/components/messenger/messenger.view.html?v=1.0.6"},"channels@messenger":{templateUrl:"app/components/messenger/channels/channels.view.html?v=1.0.6"}}}).state("messenger.home",{url:"/",template:'<div ng-controller="messagesController" class="msg-landing"><img src="static/img/tecom-bw.png" class="img-responsive" tour-step tour-step-content="سلام. به تیکام خوش اومدی! خوشحال می‌شم یه توضیح کوتاه بهت بدم... (۱/۸)" tour-step-order="0" tour-step-placement="right" /><h1>لطفا یک گروه را انتخاب کنید.</h1></div>'}).state("messenger.messages",{url:"/:slug",views:{"":{templateUrl:"app/components/messenger/messages/messages.view.html?v=1.0.8"},"header@messenger.messages":{templateUrl:"app/components/messenger/header/header.view.html?v=1.0.4"},"files@messenger.messages":{templateUrl:"app/components/files/files.view.html?v=1.0.6"},"filemanager@messenger.messages":{templateUrl:"app/components/files/filemanager-files.view.html?v=1.0.0"}},params:{slug:null}})}]),angular.module("config",[]).constant("ENV",{name:"dev",socketUri:"ws.localhost:8000"}),app.factory("ArrayUtil",function(){function a(a,b,c){for(var d=b.split("."),e=0;e<a.length;e++){for(var f=a[e],g=0;g<d.length;g++)f=f[d[g]];if(f==c)return e}return-1}function b(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return c;return-1}function c(b,c,d){var e=a(b,c,d);return-1===e?null:b[e]}function d(a){return 0===a.length?null:a[a.length-1]}function e(a,b){b>-1&&a.splice(b,1)}function f(b,c,d){var e=a(b,c,d);e>-1&&b.splice(e,1)}function g(a,c){var d=b(a,c);d>-1&&a.splice(d,1)}function h(a,b){return a.indexOf(b)>-1}function i(b,c,d){return a(b,c,d)>-1}function j(a,b){a.sort(function(a,c){return a[b]<c[b]?1:a[b]>c[b]?-1:0})}return{getIndexByKeyValue:a,getIndexByValue:b,getElementByKeyValue:c,getLastElement:d,removeElementByIndex:e,removeElementByKeyValue:f,contains:h,containsKeyValue:i,removeElementByValue:g,sortByKeyDesc:j}}),app.factory("textUtil",function(){function a(a){if(!a)return!1;var b=/^[a-zA-Z0-9.?><\/\\:;,{}()$[\]\-_+=!@#$%\^&*|'"` ]*$/,c=!0;return a.split(" ").forEach(function(a){c=c&&b.test(a)}),c}function b(a){for(var b="",d=!0,g=a.split("`"),h=0;h<g.length-1;h++)b+=d?c(f(g[h])):e(g[h]),d=!d;return b+=c(f(g[g.length-1]))}function c(a){var b=/[-a-zA-Z0-9@:%_\+.~#?&\/\/=]{2,256}\.[a-z]{2,4}\b(\/[-a-zA-Z0-9@:%_\+.~#\?&\/\/=]*)?/gi;return a.replace(b,function(a){if(d(a)){var b=a;return-1===a.indexOf("//")&&(b="//"+a),'<a href="'+b+'" target="_blank">'+a+"</a>"}return a})}function d(a){var b=["com","ir","net","org","biz","info","name","me","ws","us","tv","gov","co","edu","asia","int","tel","mil","coop","io","jobs","mobi","pro"];a=a.split("."),a=a[a.length-1];for(var c=0;c<b.length;c++)if(a.substring(0,b[c].length)===b[c])return!0;return!1}function e(a){return'<code class="msg-inline-code" dir="ltr">'+a+"</code>"}function f(a){if(!/\b((?!=|\,|\.).)+(.)\b/.test(a))return a;var b=/([^\u0600-\u065F\u066E-\u06D5]+)/g;return a.replace(b,function(a){if(" "===a)return a;var b=" "===a[0],c=" "===a[a.length-1];return(b?" ":"")+'<span style="direction:ltr" dir="ltr">'+a.trim()+"</span> "+(c?" ":"")})}function g(a){var b=/(^|\W)(#[a-z\d][\w-]*)/gi;return a.replace(b,'$1<a href="/$2">$2</a>')}function h(a){var b={0:"۰",1:"۱",2:"۲",3:"۳",4:"۴",5:"۵",6:"۶",7:"۷",8:"۸",9:"۹"},c=a.match(/[0-9]/g);if(null!==c&&0!==c.length)for(var d=0;d<c.length;d++)a=a.replace(c[d],b[c[d]]);return a}function i(a){var b=a.replace(/</g,"&lt");return b=b.replace(/>/g,"&gt"),b=b.replace(/{/g,"&#123;&zwnj;"),b=b.replace(/}/g,"&zwnj;&#125;")}return{isEnglish:a,htmlify:b,hashtagify:g,persianify:h,htmlToPlaintext:i}}),app.factory("domainUtil",["$location",function(a){function b(){var b=a.host();return b.indexOf(".")<0?"":b.split(".")[0]}return{getSubdomain:b}}]),app.factory("validationUtil",function(){function a(a){return/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(a)}return{validateEmail:a}}),app.factory("dateUtil",["$window",function(a){function b(b){return a.persianDate(b).format("dddd DD MMMM")}function c(b){return a.persianDate(b).format("h:mm")}return{getPersianDateString:b,getPersianTime:c}}]),app.factory("fileUtil",["ArrayUtil",function(a){function b(b){return a.contains(e,b)}function c(b){return a.contains(f,b)}function d(b){return a.contains(e,b)?1:a.contains(f,b)?2:a.contains(g,b)?3:4}var e=["txt","c","js","java","py","cpp","css","apsx","htm","jsp","php","xml","asp","rdf","cs","fs","lib","s","src","dtd","bat","o","mm","swift","cc","lua","prl","mac","phtml","sh","h","html5","cxx","vb","r","cls","pyt","cmd","rb","p","php3","cbl","perl","f","dtx","sub","ptl","ksf","dsd","mak","scpt","less","run","cp","m","obj","lpx","ascx","coffee","script","rh","jade","j","jav","xtx","c#","f#","f95","mf","devpak","f90","phps","ruby","command","jcs","scala","for","bsh","c++","dfn","php2","iml","php5","hc","make","vim","ogr","sass","cuh","vc6","cobol","rdoc","sql","rub","playground","phs","pdr","xib","vbscript","rc3","php1","hxx","d","proto","asp+","snippet","cu","applescript","git","ijs","ftn","pbp","cfo","map","rb","xpdl","vmx","common","go","login","udf","a","sbs","chh","phpt","gemfile","class","pp","hh","b","mst","cola","zsh","ahtml","rex","mod","has","w","reb","msc","rake","tcsh","tql","erl","hpp","gml","rbx","mli","pdl","pxi","simba","xmljet","fpp","pdl","gs","rs","magik","cr2","gst","con","sit","qf","gnumakefile","fdo","epp","emakefile","sw","ks","m2","pm6","p5","adiumscripts","eql","lit","xmss","seestyle","makefile","sjava","emakerfile","cuo","rtf","es6","hbs","erb","scss"],f=["ani","bmp","cal","eps","fax","gif","img","jbg","jpe","jpeg","jpg","mac","pbm","pcd","pcx","pct","pgm","png","ppm","psd","ras","tga","tiff","wmf"],g=["pdf","doc","docx","xls","xlsx","ppt","pptx","odx","txt","rtf"];return{isTextFormat:b,isPictureFormat:c,fileManagerFileFormat:d}}]),app.directive("compile",["$compile",function(a){return{scope:!0,link:function(b,c,d){d.$observe("template",function(d){if(angular.isDefined(d)){d="<div>"+d+"</div>";var e=a(d)(b);c.html(""),c.append(e)}})}}}]),app.directive("confirmDialog",function(){function a(a,b){var c=b.isAnchor?"a":"button",d="<"+c+' class="{{class}}" mwl-confirm message="{{message}}" confirm-text="{{ok}}"  animation="true" cancel-text="{{cancel}}" placement="bottom"  on-confirm="callUpdate()" confirm-button-type="{{confirmButton}}"  cancel-button-type="default">';return b.icon?d+='<span class="{{icon}}"></span>':d+="{{buttonName}}",d+="</"+c+">"}return{scope:{class:"@",icon:"@",buttonName:"@",message:"@",cancel:"@",ok:"@",confirmButton:"@",isAnchor:"@",confirmFunc:"&",args:"="},replace:!0,template:a,link:function(a,b,c){a.callUpdate=function(){var b=a.confirmFunc();a.args?b.apply(null,a.args):b()}}}}),app.factory("socket",["$rootScope","$log","ENV","$uibModal","domainUtil","$localStorage",function(a,b,c,d,e,f){var g=this,h=e.getSubdomain();return g.socket=io.connect(c.socketUri,{path:"/",query:{token:f.token,teamSlug:h},extraHeaders:{Connection:"keep-alive"}}),g.socket.on("connect",function(){b.info("Socket opened and connection established successfuly."),a.socketConnected=!0,a.$broadcast("socket:connected")}),g.socket.on("disconnect",function(){b.error("Socket disconnected."),a.socketConnected=!1}),g.socket.on("err",function(a){b.info("Error On Socket :",a)}),{on:function(b,c){g.socket.on(b,function(){var b=arguments;a.$apply(function(){c.apply(g.socket,b)})})},emit:function(b,c,d){g.socket.emit(b,c,function(){var b=arguments;a.$apply(function(){d&&d.apply(g.socket,b)})})}}}]),app.factory("User",function(){function a(a,b,c,d){this.id=a,this.username=b,this.email=c,this.image=d||"/static/img/user-def.png",this.usernameColor="#"+(16777215*Math.random()<<0).toString(16)}return a}),app.factory("Team",["$http","socket","$q","$log","$localStorage","ArrayUtil","Member",function(a,b,c,d,e,f,g){function h(){}return h.initialize=function(a){h.id=a,h.members=[],h.membersPromise=h.getTeamMembers(),h.getName().then(function(a){h._name=a.name})},h.getTeamMembers=function(){var a=c.defer();return b.emit("team:members",null,function(b){h.members=b.map(function(a){return new g(a.id,a.isAdmin,a.user_id,a.username,a.email,a.image,a.status)}),a.resolve()}),a.promise},h.getName=function(){return a({method:"GET",url:"/api/v1/teams/"+h.id+"/name/",headers:{Authorization:"JWT "+e.token}})},h.getUsernameByMemberId=function(a){if(a===g.TECOM_BOT.id)return g.TECOM_BOT.username;var b=f.getElementByKeyValue(h.members,"id",a);return b?b.user.username:""},h.getMemberByUsername=function(a){if(a===g.TECOM_BOT.username)return g.TECOM_BOT;var b=f.getElementByKeyValue(h.members,"user.username",a);return b||(d.error("Member Not Found !"),null)},h.getMemberByMemberId=function(a){if(a===g.TECOM_BOT.id)return g.TECOM_BOT;var b=f.getElementByKeyValue(h.members,"id",a);return b||d.error("Member Not Found !"),b},h.getActiveMembers=function(){return h.members.filter(function(a){return a.isActive()})},h.isMemberActiveByUsername=function(a){var b=h.getMemberByUsername(a);return!!b&&(b.id===g.TECOM_BOT.id||b.isActive())},h.getImageByMemberId=function(a){return h.getMemberByMemberId(a).image},h}]),app.factory("teamService",["$rootScope","$window","socket","Team","ArrayUtil","channelsService","AuthService","Channel","Member","CurrentMember",function(a,b,c,d,e,f,g,h,i,j){function k(a){var b=d.getMemberByMemberId(a);b&&(b.status=i.STATUS.DEACTIVE)}return c.on("member:new",function(b){var c=new i(b.id,b.isAdmin,b.user_id,b.username,b.email,b.image,i.STATUS.ONLINE);d.members.push(c),f.createAndPushChannel({name:c.user.username,slug:c.user.username,type:h.TYPE.DIRECT,memberId:c.id,isFakeDirect:!0}),a.$broadcast("channels:updated")}),c.on("member:remove",function(c){if(c===j.member.id)g.logout().then(function(){b.location.assign("/login?err=UserRemoved")});else{k(c);var e=d.getUsernameByMemberId(c);f.setDirectActiveState(e,!1),a.$broadcast("channels:updated"),a.$broadcast("members:updated")}}),c.on("member:status:change",function(a){d.getMemberByMemberId(a.memberId).status=a.status}),{deactiveTeamMember:k}}]).run(["teamService",function(a){}]),app.factory("CurrentMember",["Member","$localStorage","$timeout","textUtil","$interval",function(a,b,c,d,e){function f(){}return f.initialize=function(b,c,d,e,g,h){f.member=new a(b,c,d,e,g,h,a.STATUS.ONLINE)},f.exists=function(){return!!f.member},f.initializeDontDisturbMode=function(){if(f.dontDisturb={},b.dontDisturb){var a=b.dontDisturb.duration;a?f.checkShouldContinueTimeActive(a):f.dontDisturb.mode=b.dontDisturb.mode}else f.initializeInitialJsons()},f.initializeInitialJsons=function(){var a={mode:f.DONT_DISTURB_MODE.DEACTIVE};b.dontDisturb=a,f.dontDisturb.mode=b.dontDisturb.mode},f.checkShouldContinueTimeActive=function(a){var c=+new Date,d=b.dontDisturb.startTime;c-d<a?f.activateTimeDontDisturbMode(d+a-c):(f.removeDontDisturbModeTimeProperties(),f.setDontDisturbMode(f.DONT_DISTURB_MODE.DEACTIVE))},f.setDontDisturbMode=function(a){b.dontDisturb.mode=a,f.dontDisturb.mode=a},f.activateTimeDontDisturbMode=function(a){f.setDontDisturbModeTimeProperties(a),f.setDontDisturbMode(f.DONT_DISTURB_MODE.TIMEACTIVE),f.setDontDisturbTimeout(a),f.dontDisturbInterval=e(function(){f.updateDontDisturbRemainingTime()},1e3)},f.activateDontDisturbMode=function(){f.dontDisturb.mode===f.DONT_DISTURB_MODE.TIMEACTIVE&&(f.removeDontDisturbModeTimeProperties(),c.cancel(f.dontDisturbTimeout),f.removeDontDisturbModeRemainingTime()),f.setDontDisturbMode(f.DONT_DISTURB_MODE.ACTIVE)},f.deactivateDontDisturbMode=function(){f.dontDisturb.mode===f.DONT_DISTURB_MODE.TIMEACTIVE&&(f.removeDontDisturbModeTimeProperties(),c.cancel(f.dontDisturbTimeout),f.removeDontDisturbModeRemainingTime()),f.setDontDisturbMode(f.DONT_DISTURB_MODE.DEACTIVE)},f.setDontDisturbModeTimeProperties=function(a){var c=+new Date;f.dontDisturb.duration=a,b.dontDisturb.duration=a,f.dontDisturb.startTime=c,b.dontDisturb.startTime=c},f.removeDontDisturbModeTimeProperties=function(){delete b.dontDisturb.duration,f.dontDisturb.duration=null,delete b.dontDisturb.startTime,f.dontDisturb.startTime=null},f.removeDontDisturbModeRemainingTime=function(){e.cancel(f.dontDisturbInterval),f.dontDisturb.remainingTime=null},f.setDontDisturbTimeout=function(a){f.dontDisturbTimeout=c(function(){f.removeDontDisturbModeTimeProperties(),f.setDontDisturbMode(f.DONT_DISTURB_MODE.DEACTIVE),e.cancel(f.dontDisturbInterval)},a)},f.isDontDisturbModeActive=function(){return f.dontDisturb.mode===f.DONT_DISTURB_MODE.ACTIVE},f.isDontDisturbModeDeactive=function(){return f.dontDisturb.mode===f.DONT_DISTURB_MODE.DEACTIVE},f.isDontDisturbModeTimeActive=function(){return f.dontDisturb.mode===f.DONT_DISTURB_MODE.TIMEACTIVE},f.updateDontDisturbRemainingTime=function(){f.dontDisturb.remainingTime=f.getLocaleDontDisturbRemainingTime()},f.getLocaleDontDisturbRemainingTime=function(){var a=(f.dontDisturb.duration+f.dontDisturb.startTime-+new Date)/1e3,b=Math.floor(a/60),c=Math.floor(a%60);return d.persianify(c.toString()+" : "+b.toString())},f.DONT_DISTURB_MODE={DEACTIVE:0,ACTIVE:1,TIMEACTIVE:2},f}]),app.factory("Member",["User",function(a){function b(b,c,d,e,f,g,h){this.id=b,this.isAdmin=c,this.user=new a(d,e,f,g),this.status=h}return b.prototype.isTecomBot=function(){return this.id===b.TECOM_BOT.id},b.prototype.isActive=function(){return this.status!==b.STATUS.DEACTIVE},b.TECOM_BOT={id:0,username:"تیک-بات"},b.STATUS={OFFLINE:0,ONLINE:1,DEACTIVE:2},b}]),app.factory("AuthService",["$log","$http","$q","$window","$timeout","$localStorage","jwtHelper","ArrayUtil","CurrentMember","$injector","domainUtil","validationUtil","$rootElement",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){o(f.token,k.getSubdomain())}function o(a,b){var c=g.decodeToken(a),d=h.getElementByKeyValue(c.memberships,"team_slug",b);i.initialize(d.id,d.is_admin,c.user_id,c.username,c.email,c.image),s.initialize(d.team_id)}function p(a){f.token=a}function q(a,d){var e=c.defer(),f={password:d,teamSlug:k.getSubdomain()};return l.validateEmail(a)?f.email=a:f.username=a,b({method:"POST",url:"/api/v1/auth/login/",data:f,skipAuthorization:!0}).then(function(a){var b=a.data.token;b?(p(b),e.resolve()):e.reject()}).catch(function(a){e.reject(a)}),e.promise}function r(){var d=c.defer();return b.post("/api/v1/auth/logout/").then(function(b){a.info(b),d.resolve()}).catch(function(b){a.info("Logout error.",b),d.reject()}),d.promise}var s;return"tecomApp"===m.attr("ng-app")&&(s=j.get("Team"),n()),{initialize:n,createUser:o,login:q,logout:r}}]),app.service("db",["$window","$q","$log","CurrentMember","Team",function(a,b,c,d,e){function f(){var a=b.defer();return h.isIndexReady?a.resolve(h.db):h.createIndexPromise.then(function(){a.resolve(h.db),h.isIndexReady=!0}),a.promise}function g(){h.db.destroy().then(function(a){c.info("Database cleared succesfully.")}).catch(function(a){c.error("Error clearing database.",a)})}var h=this;if(d.exists())return function(){h.db=new a.PouchDB("tecom:"+e.id+":"+d.member.id),c.info("PouchDB connected successfuly."),h.createIndexPromise=h.db.createIndex({index:{fields:["id","channelId"]}})}(),{getDb:f,destroy:g}}]),app.run(["$window","$exceptionHandler",function(a,b){a.onerror=function(a,c,d,e,f){f||(f=new Error(a)),b(f)}}]),app.config(["$provide",function(a){a.decorator("$exceptionHandler",["$delegate","$injector",function(a,b){return function(c,d){a(c,d);var e=b.get("$http"),f=b.get("$log"),g=b.get("CurrentMember"),h={message:c.message,stacktrace:c.stack,user_agent:window.navigator.userAgent};g.exists()&&(h.member=g.member.id),e.post("/api/v1/logs/create/",h).then(function(){f.info("Error log sent to server successfully. We will fix it soon.")}).catch(function(){f.error("Error sending error log to server")})}}])}]),app.factory("authInterceptor",["$q","$log","$localStorage","$window",function(a,b,c,d){return{responseError:function(e){switch(b.error("Http response error. Rejection status:",e.status),e.status){case 401:c.token=null,d.location.assign("/login?err=InvalidToken")}return a.reject(e)}}}]).config(["$httpProvider",function(a){a.interceptors.push("authInterceptor")}]),app.controller("MessengerCtrl",["$rootScope","$scope","$window","$uibModal","AuthService","CurrentMember","$localStorage","$state","$http","$templateCache",function(a,b,c,d,e,f,g,h,i,j){function k(){i.get("app/components/messenger/messages/messages.view.html?v=1.0.8",{cache:j}),i.get("app/components/messenger/header/header.view.html?v=1.0.4",{cache:j}),i.get("app/components/files/files.view.html?v=1.0.6",{cache:j}),i.get("app/components/files/filemanager-files.view.html?v=1.0.0",{cache:j})}function l(){g.userSeenTour||(b.tour.start(),g.userSeenTour=!0)}b.isAdmin=f.member.isAdmin,a.isTabFocused=!0,b.activeFile=!1,b.openUserProfileModal=function(){d.open({animation:!0,templateUrl:"app/components/profile/user.profile.view.html",controller:"userProfileController"})},b.openTeamProfileModal=function(){d.open({animation:!0,templateUrl:"app/components/profile/team.profile.view.html?v=1.0.0",controller:"teamProfileController",resolve:{tourClicked:function(){return null}}})},function(){c.Notification.requestPermission(),f.initializeDontDisturbMode(),k()}(),b.$on("view:state:changed",function(a,c){b.activeFile="noFile"!==c}),b.$on("loading:finished",function(){l()}),b.getPannelsCSS=function(a){return"messages"===a?b.activeFile?"col-sm-6 col-lg- no-padding":"col-sm-8 col-lg- no-padding":"files"===a?b.activeFile?"col-sm-6 col-lg-6 no-padding doc-section":"col-sm-4 col-lg- no-padding":void 0},b.logout=function(){e.logout().then(function(){c.location.href="/login"})},b.getDontDisturbModeClass=function(){switch(f.dontDisturb.mode){case f.DONT_DISTURB_MODE.DEACTIVE:return"zmdi zmdi-notifications-active";case f.DONT_DISTURB_MODE.ACTIVE:return"zmdi zmdi-notifications-off";case f.DONT_DISTURB_MODE.TIMEACTIVE:return"zmdi zmdi-notifications-paused"}},b.activateTimeDontDisturbMode=function(a){f.activateTimeDontDisturbMode(6e4*a)},b.activateDontDisturbMode=function(){f.activateDontDisturbMode()},b.deactivateDontDisturbMode=function(){f.deactivateDontDisturbMode()},b.getDontDisturbModeRemainingTime=function(){return f.dontDisturb.remainingTime},b.setNotificationPermission=function(){"default"===c.Notification.permission?c.Notification.requestPermission():"denied"===c.Notification.permission&&c.Notification.requestPermission()},b.shouldShowNotificationPermission=function(){return"granted"!==c.Notification.permission},b.navigateToHome=function(){h.go("messenger.home")},angular.element(c).bind("focus",function(){a.isTabFocused=!0,a.$broadcast("tab:focus:changed")}).bind("blur",function(){a.isTabFocused=!1,a.$broadcast("tab:focus:changed")}),angular.element(c).bind("focus",function(){a.isTabFocused=!0,a.$broadcast("tab:focus:changed")}).bind("blur",function(){a.isTabFocused=!1,a.$broadcast("tab:focus:changed")})}]),app.factory("Channel",["$stateParams","textUtil","ArrayUtil","$q","CurrentMember","Team","Member",function(a,b,c,d,e,f,g){function h(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p){this.setValues(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p),this.isTypingMemberIds=[],this.hideNotifFunction=null,this.initialMessagesPromise=null}return h.prototype.setValues=function(a,b,c,d,e,g,h,i,j,k,l,m,n,o,p,q){this.name=a,this.slug=b,this.description=c,this.type=d,this.id=e,this.membersCount=g,h&&(this.member=f.getMemberByMemberId(h)),this.isFakeDirect=i,this.liveFileId=j,this.teamId=k,this.active=!0,this.isCurrentMemberChannelMember=l,this.isMuted=m,this.lastSeenId=n,o&&(this.lastDatetime=new Date(o)),this.lastMessageId=p,this.memberLastSeenId=q||0},h.prototype.hasUnread=function(){return this.getNotifCount()&&0!==this.getNotifCount()},h.prototype.isCurrentMemberPublicChannelMember=function(){return!this.isPublic()||this.isCurrentMemberChannelMember},h.prototype.getDescription=function(){return this.description||"این گروه توضیحی ندارد."},h.prototype.shouldSendNotification=function(){return this.hideNotifFunction&&(this.hideNotifFunction(),this.hideNotifFunction=null),this.isCurrentMemberPublicChannelMember()&&e.isDontDisturbModeDeactive()&&!this.isMuted},h.prototype.updateFromJson=function(a){this.name=a.name||null,this.slug=a.slug||null,this.description=a.description||null,this.type=a.type},h.prototype.getLocaleNotifCount=function(){return this.hasUnread()?b.persianify(this.getNotifCount().toString()):null},h.prototype.getLocaleMembersCount=function(){return this.membersCount?b.persianify(this.membersCount.toString()):null},h.prototype.setLastDatetime=function(a){this.lastDatetime=a},h.prototype.setLastSeen=function(a){this.lastSeenId=a},h.prototype.seenLastMessage=function(){this.lastMessageId++,this.memberLastSeenId++},h.prototype.areAllMessagesHaveBeenSeen=function(a){return this.memberLastSeenId===this.lastMessageId},h.prototype.addIsTypingMemberId=function(a){this.isTypingMemberIds.push(a)},h.prototype.removeIsTypingMemberId=function(a){c.removeElementByValue(this.isTypingMemberIds,a)},h.prototype.getIsTypingString=function(){var a="";return angular.forEach(this.isTypingMemberIds,function(b){a+=f.getUsernameByMemberId(b),a+=" و "}),a.slice(0,a.length-3)},h.prototype.anyoneTyping=function(){return this.isTypingMemberIds.length>0},h.prototype.isSelected=function(){var b=this.isDirect()?"@"+this.slug:this.slug;return a.slug===b},h.prototype.setInitialMessagesPromise=function(a){this.initialMessagesPromise=a},h.prototype.getIconClass=function(){switch(this.type){case h.TYPE.PUBLIC:return"fa fa-globe";case h.TYPE.PRIVATE:return"fa fa-lock";case h.TYPE.DIRECT:if(e.member.isTecomBot())return"zmdi zmdi-circle member-status status-offline";if(this.slug===g.TECOM_BOT.username)return"fa fa-heart";switch(this.member.status){case g.STATUS.OFFLINE:return"zmdi zmdi-circle member-status status-offline";case g.STATUS.ONLINE:return"zmdi zmdi-circle member-status status-online";case g.STATUS.DEACTIVE:return"zmdi zmdi-circle member-status status-deactive"}}},h.prototype.getDirectStatus=function(){if(e.member.isTecomBot())return"آفلاین";if(this.slug===g.TECOM_BOT.username)return"همیشه آنلاین";switch(this.member.status){case g.STATUS.OFFLINE:return"آفلاین";case g.STATUS.ONLINE:return"آنلاین";case g.STATUS.DEACTIVE:return"حذف شده از تیم"}},h.prototype.getNotifCountClass=function(){return this.isCurrentMemberChannelMember?"badge":"badge badge-grey"},h.prototype.getNotifCount=function(){return this.memberLastSeenId?this.lastMessageId-this.memberLastSeenId:this.lastMessageId},h.prototype.getCssClass=function(){return this.isSelected()?"active":""},h.prototype.isPrivate=function(){return this.type===h.TYPE.PRIVATE},h.prototype.isDirect=function(){return this.type===h.TYPE.DIRECT},h.prototype.isPublic=function(){return this.type===h.TYPE.PUBLIC},h.prototype.canMemberSendMessage=function(){return!this.getIsRemoved()&&!this.getIsArchived()&&this.active&&this.isCurrentMemberPublicChannelMember()},h.prototype.changeNameAndSlugFromId=function(){var a=this,b=[];b.push(parseInt(this.slug.slice(0,this.slug.indexOf(":")))),b.push(parseInt(this.slug.slice(this.slug.indexOf(":")+1,this.slug.length))),b.forEach(function(b){b!==e.member.id&&a.setNameAndSlugById(b)})},h.prototype.setNameAndSlugById=function(a){var b=f.getUsernameByMemberId(a);this.name=b,this.slug=b},h.prototype.getChannelData=function(){return{name:this.name,description:this.description,type:this.type}},h.prototype.getUrlifiedSlug=function(){return this.isDirect()?"@"+this.slug:this.slug},h.prototype.setIsRemoved=function(){this.isRemoved=!0,this.isCurrentMemberChannelMember=!1},h.prototype.getIsRemoved=function(){return this.isRemoved||!1},h.prototype.setIsArchived=function(){this.isArchived=!0},h.prototype.getIsArchived=function(){return this.isArchived||!1},h.TYPE={PUBLIC:0,PRIVATE:1,DIRECT:2},h}]),app.controller("channelsController",["$rootScope","$scope","$window","$state","$uibModal","$q","channelsService","webNotification","textUtil","$log","CurrentMember",function(a,b,c,d,e,f,g,h,i,j,k){function l(a){h.showNotification(a.name,{body:"شما "+a.getLocaleNotifCount()+" پیام خوانده نشده دارید.",icon:"favicon.png",onClick:function(){a.hideNotifFunction(),a.hideNotifFunction=null,c.focus(),d.go("messenger.messages",{slug:a.getUrlifiedSlug()})}},function(b,c){b?j.error("Unable to show notification: "+b.message):(a.hideNotifFunction=c,setTimeout(function(){a.hideNotifFunction=null,c()},5e3))})}function m(){b.channels.current||d.go("messenger.home")}function n(){b.channels.publicsAndPrivates=g.getPublicsAndPrivates(),b.channels.directs=g.getDirects()}function o(){a.hasUnread=g.anyChannelHasUnread()}function p(a){g.updateChannelNotification(a,"inc")}b.channels={},b.channels.publicsAndPrivates=[],b.channels.directs=[],b.$on("channels:updated",function(){n(),o()}),b.$on("channel:changed",function(){b.channels.current=g.getCurrentChannel(),m()}),b.$on("message",function(c,d){var e=g.findChannelById(d.channelId);if(a.isTabFocused)if(b.channels.current){var f=d.channelId===b.channels.current.id;f||d.isFromMe()||p(d.channelId)}else p(d.channelId);else p(d.channelId),e.shouldSendNotification()&&l(e)}),b.openTeamProfileModal=function(a){var b=!1;a.getStatus()===a.Status.ON&&(b=!0,a.end());e.open({animation:!0,templateUrl:"app/components/profile/team.profile.view.html?v=1.0.0",controller:"teamProfileController",resolve:{tourClicked:function(){return b}}})},b.openCreateChannelModal=function(a){e.open({animation:!0,templateUrl:"app/components/messenger/channels/channel-create.view.html?v=1.0.1",controller:"createChannelController"}).result.then(function(){},function(){})},b.navigateToAndWaitFor=function(a,c){if(b.channels.publicsAndPrivates.length)return d.go("messenger.messages",{slug:b.channels.publicsAndPrivates[0].slug}),a.waitFor(c)},b.scrollToDirects=function(){document.getElementById("groups").scrollTop=document.getElementById("channels").scrollHeight},b.navigateToHomeAndScrollToChannels=function(){d.go("messenger.home"),document.getElementById("groups").scrollTop=0},b.scrollToProgress=function(){var a=document.getElementById("groups");a.scrollTop=a.scrollHeight}}]),app.controller("createChannelController",["$scope","$uibModalInstance","$log","channelsService","Channel","ArrayUtil","CurrentMember","Team",function(a,b,c,d,e,f,g,h){function i(){h.getActiveMembers().forEach(function(b){a.teamMembers.push(b),b.selected=!1}),f.removeElementByKeyValue(a.teamMembers,"id",g.member.id)}a.forms={},a.newChannel={},a.teamMembers=[];var j=[],k=function(){j=[],j.push(g.member.id.toString());for(var b=0;b<a.teamMembers.length;b++)!0===a.teamMembers[b].selected&&j.push(a.teamMembers[b].id.toString())};a.formNameCheckEmpty=function(a){return(a.name.$touched||a.$submitted)&&!a.name.$viewValue},a.formNameCheckMax=function(a){return a.name.$viewValue&&a.name.$invalid},a.closeCreateChannel=function(){b.close()},a.createChannelSubmit=function(){a.newChannel.serverError=!1,!0===a.forms.newChannelForm.$valid&&l()},a.teamMemberClick=function(a){a.selected=!a.selected},a.getCssClass=function(a){return a.selected?"selected":"selectable"};var l=function(){k();var b=a.newChannel.isPrivate?e.TYPE.PRIVATE:e.TYPE.PUBLIC,f={name:a.newChannel.name,description:a.newChannel.description,type:b,member_ids:j,creator:g.member.id,team:h.id};d.createChannel(f).then(function(){a.closeCreateChannel()}).catch(function(b){-1!=b.indexOf("Duplicate slug in team.")?(c.error("Error Creating new Channel:",b),a.newChannel.dublicateError=!0):a.newChannel.serverError=!0})};angular.element(document).ready(function(){m()});var m=function(){a.newChannel.name="",a.newChannel.description="",a.newChannel.isPrivate=!1,a.newChannel.dublicateError=!1,a.newChannel.serverError=!1,a.forms.newChannelForm.$setPristine(),i()}}]),app.controller("channelDetailsController",["$scope","$uibModalInstance","$log","channelsService","ArrayUtil","Channel","ChannelMemberItem","CurrentMember","Team",function(a,b,c,d,e,f,g,h,i){function j(){a.details.name=s.name,a.details.description=s.description,a.details.isPrivate=s.type===f.TYPE.PRIVATE,r()}function k(){i.getActiveMembers().forEach(function(b){var c=new g(b.id);a.channelMemberItems.push(c)})}function l(){d.getChannelMembers(a.channel.id).then(function(a){a&&a.data&&a.data.forEach(function(a){var b=m(a.member);b&&b.setChannelMemberId(a.id)})})}function m(b){return e.getElementByKeyValue(a.channelMemberItems,"teamMemberId",b)}function n(b){d.addMembersToChannel(b,a.channel.id).then(function(a){o(a)}).catch(function(){a.serverError=!0,p()})}function o(b){b.forEach(function(b){e.getElementByKeyValue(a.channelMemberItems,"teamMemberId",b.member).setChannelMemberId(b.id)})}function p(){a.channelMemberItems.forEach(function(a){a.removeFromTemporary()})}function q(){a.channelMemberItems.forEach(function(a){a.isSelected=!1})}function r(){a.serverError=!1,a.forms.detailsForm.name.$error.duplicate=!1}a.editMode=!1,a.addMemberMode=!1,a.channel=d.getCurrentChannel(),a.isMuted=a.channel.isMuted,a.isAdmin=h.member.isAdmin,a.details={},a.forms={},a.serverError=!1,a.channelMemberItems=[];var s;a.editChannelClick=function(){a.editMode=!0,a.serverError=!1,s=d.getCurrentChannel().getChannelData(),j()},a.submitChannelDetailsForm=function(){r(),a.forms.detailsForm.$setPristine();var b=a.details.isPrivate?f.TYPE.PRIVATE:f.TYPE.PUBLIC,e={name:a.details.name,description:a.details.description,type:b,id:a.channel.id};d.sendEditedChannel(e).then(function(){r(),a.editMode=!1,c.info("Done Editing Channel")}).catch(function(b){-1!=b.indexOf("Duplicate slug in team.")?(a.forms.detailsForm.name.$error.duplicate=!0,c.error("Error : Dublicate Slug")):(a.serverError=!0,c.error("Error sending new channel form to server :",b))})},angular.element(document).ready(function(){t()});var t=function(){a.details.duplicateError=!1,a.forms.detailsForm.$setPristine(),a.forms.detailsForm.$submitted=!1,a.addedMemberIds=[],k(),l()};a.toggleIsMuted=function(){a.channel.isMuted=a.isMuted,d.toggleIsMuted(a.channel.id)},a.removeMember=function(b){var e={channelMemberId:b.channelMemberId,memberId:b.teamMemberId,channelId:a.channel.id,channelType:a.channel.type};d.removeMemberFromChannel(e).then(function(){b.removeChannelMemberId(),c.info("Member Removed from Channel")}).catch(function(a){c.error("Error Removing member from channel:",a)})},a.addMembersClick=function(){a.addMemberMode=!0,r()},a.submitAddedMembers=function(){r();var b=[];a.channelMemberItems.forEach(function(a){a.isSelected&&!a.isChannelMember()&&(b.push(a.teamMemberId),a.setTemporaryInChannel())}),b.length>0&&n(b),a.addMemberMode=!1},a.isUserAdmin=function(){return h.member.isAdmin},a.archiveChannel=function(){r(),d.archiveChannel(a.channel.id).then(function(){a.$close()}).catch(function(){a.serverError=!0})},a.cancelEditMode=function(){a.editMode=!1,j(),r()},a.cancelAddingMembers=function(){a.addMemberMode=!1,q(),r()}}]),app.service("channelsService",["$rootScope","$http","$q","$log","socket","Channel","$state","CurrentMember","Team","ArrayUtil",function(a,b,c,d,e,f,g,h,i,j){function k(){e.emit("channel:init",null,function(b){
j.sortByKeyDesc(b,"lastMessageDatetime"),N.channels=[],N.initChannelsCount=b.length,0===N.initChannelsCount&&(a.isLoading=!1),i.membersPromise.then(function(){b.forEach(function(b){var c=n(b);a.$emit("channel:new",c)})}),N.initialChannelsGottenForFirstTime=!0})}function l(b,c){o(b).liveFileId=c,a.$broadcast("channels:updated")}function m(a,b){p(a).active=b}function n(a){var b=new f(a.name,a.slug,a.description,a.type,a.id,a.membersCount,a.memberId,a.isFakeDirect,a.liveFileId,a.teamId,a.isCurrentMemberChannelMember,a.isMuted,a.lastSeenMessageId,a.lastMessageDatetime,a.lastMessageId,a.memberLastSeenMessageId);if(b.isDirect()&&!b.isFakeDirect&&!h.member.isTecomBot()){b.changeNameAndSlugFromId(),i.isMemberActiveByUsername(b.slug)||(b.active=!1);var c=p(b.slug);if(c)return c.setValues(b.name,b.slug,b.description,b.type,b.id,b.membersCount,null,b.memberId,!1,b.liveFileId),c}return N.channels.push(b),b}function o(a){return j.getElementByKeyValue(N.channels,"id",a)}function p(a){return j.getElementByKeyValue(N.channels,"slug",a)}function q(a){var b=c.defer();if(a){var d=p(a);d?d.isDirect()&&d.isFakeDirect?z(d.member.id).then(function(){r(d),b.resolve()}):(r(d),b.resolve()):(r(null),b.resolve())}else r(null),b.resolve();return b.promise}function r(b){N.currentChannel=b,a.$broadcast("channel:changed")}function s(){return N.currentChannel}function t(){return!a.isLoading}function u(a){var b=c.defer(),f={channelId:a};return e.emit("channel:mute:toggle",f,function(a){a.status?b.resolve():(b.reject(a.message),d.error("Toggle Channel Disturb Mode failed.",a.message))}),b.promise}function v(a){var b=c.defer();return e.emit("channel:create",a,function(a){a.status?b.resolve():(b.reject(a.message),d.error("Create channel failed.",a.message))}),b.promise}function w(a){var b=c.defer();return e.emit("channel:edit:details",a,function(a){a.status?b.resolve():b.reject(a.message)}),b.promise}function x(a,b){var d=c.defer(),f={memberIds:a,channelId:b};return e.emit("channel:members:add",f,function(a){a.status?d.resolve(a.channelMembers):d.reject()}),d.promise}function y(a){var b=c.defer();return e.emit("channel:members:remove",a,function(a){a.status?b.resolve():b.reject(a.message)}),b.promise}function z(a){var b=c.defer(),f={memberId:a};return e.emit("channel:direct:create",f,function(a){a.status?b.resolve():(b.reject(),d.error("Creating direct channel failed.",a.message))}),b.promise}function A(b,c){var d=o(b);switch(c){case"empty":d.memberLastSeenId=d.lastMessageId;break;case"inc":d.lastMessageId?d.lastMessageId++:d.lastMessageId=1}a.$broadcast("channels:updated")}function B(b,c){o(b).setLastDatetime(c),a.$broadcast("channels:updated")}function C(b,c){o(b).setLastSeen(c),a.$broadcast("channels:updated")}function D(b,c){o(b).addIsTypingMemberId(c),a.$broadcast("channels:updated")}function E(b,c){o(b).removeIsTypingMemberId(c),a.$broadcast("channels:updated")}function F(b){var d=Math.min(N.initChannelsCount,O);N.messagesPromise||(N.messagesPromise=[]),N.messagesPromise.length<d&&(N.messagesPromise.push(b),N.messagesPromise.length==d&&c.all(N.messagesPromise).then(function(){a.$broadcast("channels:updated","init")}))}function G(a){var e=c.defer();return b({method:"GET",url:"/api/v1/messenger/channels/"+a+"/members/"}).then(function(a){e.resolve(a)}).catch(function(a){d.info("Error Getting channel members.",a),e.reject(a)}),e.promise}function H(){for(var a=0;a<N.channels.length;a++)if(N.channels[a].hasUnread()&&N.channels[a].isCurrentMemberPublicChannelMember())return!0;return!1}function I(){return N.channels}function J(){return N.channels.filter(function(a){return a.isPublic()||a.isPrivate()})}function K(){return N.channels.filter(function(a){return a.isDirect()})}function L(b){j.removeElementByKeyValue(N.channels,"id",b),a.$broadcast("channels:updated")}function M(a){var b=c.defer(),f={channelId:a};return e.emit("channel:archive",f,function(a){a.status?(d.info("Channel succesfully Archived"),b.resolve()):(d.error("Error Archiving Channel : ",a.message),b.reject())}),b.promise}var N=this,O=5;return N.channels=[],N.initialChannelsGottenForFirstTime=!1,function(){k()}(),e.on("channel:new",function(b){var c=n(b.channel);b.channel.creatorId===h.member.id&&g.go("messenger.messages",{slug:c.getUrlifiedSlug()}),a.$broadcast("channels:updated")}),e.on("channel:edit",function(b){var c=o(b.channel.id),d=c.isSelected();c.updateFromJson(b.channel),d&&g.go("messenger.messages",{slug:c.slug}),a.$broadcast("channels:updated")}),e.on("channel:members:add",function(b){d.info("add member:",b);var c;if(b.channel.type===f.TYPE.PUBLIC)c=o(b.channel.id),c.isCurrentMemberChannelMember=!0;else if(b.channel.type===f.TYPE.PRIVATE){n(b.channel),a.$broadcast("channels:updated"),c=o(b.channel.id);var g={channelId:b.channel.id};e.emit("channel:messagedata",g,function(b){c.lastMessageId=b.lastMessageId,c.memberLastSeenId=b.lastMessageId-1,a.$emit("channel:new",c)})}}),e.on("channel:members:remove",function(b){var c=o(b.channel.id);b.channel.type===f.TYPE.PUBLIC?c.isCurrentMemberChannelMember=!1:b.channel.type===f.TYPE.PRIVATE&&(c.setIsRemoved(),a.$broadcast("channels:updated"))}),e.on("channel:archived",function(b){var c=o(b.channelId);c&&(c.setIsArchived(),a.$broadcast("channels:updated"))}),e.on("channel:mute:toggle",function(a){var b=o(a);b&&(b.isMuted=!b.isMuted)}),a.$on("socket:connected",function(){N.initialChannelsGottenForFirstTime&&k()}),{getPublicsAndPrivates:J,getDirects:K,getChannels:I,anyChannelHasUnread:H,createAndPushChannel:n,findChannelById:o,findChannelBySlug:p,setCurrentChannelBySlug:q,getCurrentChannel:s,areChannelsReady:t,toggleIsMuted:u,createChannel:v,sendEditedChannel:w,addMembersToChannel:x,removeMemberFromChannel:y,updateChannelNotification:A,updateChannelLastDatetime:B,updateChannelLastSeen:C,addIsTypingMemberByChannelId:D,removeIsTypingMemberByChannelId:E,addMessagesPromise:F,getChannelMembers:G,setChannelLivedFileId:l,setDirectActiveState:m,archiveChannel:M,removeChannel:L}}]),app.factory("ChannelMemberItem",["CurrentMember","Team",function(a,b){function c(a){this.member=b.getMemberByMemberId(a),this.teamMemberId=this.member.id,this.username=this.member.user.username,this.isSelected=!1,this.temporaryInChannel=!1,this.channelMemberId=null}return c.prototype.isChannelMember=function(){return!(!this.channelMemberId&&!this.temporaryInChannel)},c.prototype.setChannelMemberId=function(a){this.channelMemberId=a,this.temporaryInChannel=!1},c.prototype.removeChannelMemberId=function(){this.channelMemberId=null,this.temporaryInChannel=!1,this.isSelected=!1},c.prototype.getCssClass=function(a){return a?this.isChannelMember()?"disabled":this.isSelected?"selected":"selectable":""},c.prototype.click=function(a){a&&(this.isSelected=!this.isSelected)},c.prototype.setTemporaryInChannel=function(){this.temporaryInChannel=!0},c.prototype.removeFromTemporary=function(){this.temporaryInChannel=!1},c}]),app.controller("headerController",["$scope","$localStorage","$uibModal","$window","AuthService","db","channelsService","$state",function(a,b,c,d,e,f,g,h){a.$on("channel:changed",function(){a.channel=g.getCurrentChannel()}),a.toggleIsMuted=function(){g.toggleIsMuted(a.channel.id)},a.openChannelDetailsModal=function(){if(a.channel){c.open({templateUrl:"app/components/messenger/channels/channel-details.view.html?v=1.0.1",controller:"channelDetailsController"})}},a.clearCache=function(){b.$reset(),f.destroy(),e.logout().then(function(){d.location.href="/login"})}}]),app.factory("Message",["$log","db","textUtil","channelsService","fileUtil","dateUtil","CurrentMember","Team",function(a,b,c,d,e,f,g,h){function i(a,b,c,d,e,f,g,h,i,j){this.setValues(a,b,c,d,e,f,g,h,i,j)}return i.prototype.setValues=function(a,b,c,e,f,g,h,j,k,l){this.body=a,this.type=b,this.senderId=c,this.channelId=e,this._id=f||null,this.about=j||null,this.datetime=g?new Date(g):new Date,this.additionalData=h||null,this._id&&(this.id=i.generateIntegerId(f)),this.isPending=k||!1,this.currentChannel=d.getCurrentChannel(),this.currentChannel&&(this.teamId=this.currentChannel.teamId),this.fileTimestamp=l,this.uploadProgressBar=null},i.prototype.getUsername=function(){if(g.member.isTecomBot()||this.isLoading())return"";var b=h.getUsernameByMemberId(this.senderId);return this.isNotif()||""!==b||a.error("Empty username problem. Team members:"),b},i.prototype.getUsernameColor=function(){return g.member.isTecomBot()||!this.senderId||this.senderId===g.member.id?{}:h.getMemberByMemberId(this.senderId)?{color:h.getMemberByMemberId(this.senderId).user.usernameColor}:{}},i.prototype.getViewWellFormed=function(){var a="";if(this.type===i.TYPE.TEXT)this.about&&(a+='<a class="msg-attachment" ng-click="showFileLine('+this.about.fileId+","+this.about.lineNumber+","+this.about.lineNumberTo+')" tooltip-placement="top" uib-tooltip="در مورد...">',a+='<div><i class="zmdi zmdi-link"></i></div></a>'),a+=i.generateMessageWellFormedText(this.body);else{if(this.isFile())return this.canBeLived=e.isTextFormat(this.additionalData.type),a='<div id="'+this.getFileTimestampId()+'" class="ng-scope" dir="rtl">',e.isPictureFormat(this.additionalData.type)?a+='<img class="img-responsive" id="img-'+this.additionalData.fileId+'" ng-src="'+this.additionalData.url+'" style="cursor:pointer" fullscreen />':(a+='<label class="file-name">'+this.additionalData.name+"</label>",a+='<div class="file-icon-holder"><i class="fa fa-file"></i></div><br>'),this.canBeLived&&(this.currentChannel.canMemberSendMessage()&&(a+='<a class="live-btn" dir="ltr" ng-click="goLive('+this.additionalData.fileId+", '"+this.additionalData.name+"')\">",a+='<label dir="ltr">LIVE</label>',a+='<i class="fa fa-circle"></i>',a+="</a>"),a+='<a class="dl-btn" ng-click="viewFile('+this.additionalData.fileId+')" tooltip-placement="top" uib-tooltip="مشاهده">',a+='<i class="fa fa-eye"></i>'),a+='<a class="dl-btn" href="'+this.additionalData.url+'" download="'+this.additionalData.name+'" target="_blank" tooltip-placement="top" uib-tooltip="دانلود">',a+='<i class="zmdi zmdi-download"></i>',a+="</a></div>";if(this.type===i.TYPE.NOTIF.USER_ADDED||this.type===i.TYPE.NOTIF.USER_REMOVED){a="";var b=this.additionalData;angular.forEach(b,function(b){a+="@"+h.getUsernameByMemberId(b)+" و "}),a=a.slice(0,a.length-3),this.type===i.TYPE.NOTIF.USER_ADDED?a+=b.length>1?" به گروه اضافه شدند.":" به گروه اضافه شد.":a+=b.length>1?" از گروه حذف شدند.":" از گروه حذف شد."}else this.type===i.TYPE.NOTIF.CHANNEL_CREATED?a="گروه ساخته شد.":this.type===i.TYPE.NOTIF.CHANNEL_EDITED?a="اطلاعات گروه تغییر کرد.":this.type===i.TYPE.NOTIF.FILE_LIVED?a='فایل "'+this.additionalData.fileName+'"، <span class="live-btn"><label dir="ltr">LIVE</label><i class="fa fa-circle"></i></span> شد.':this.type===i.TYPE.NOTIF.FILE_DIED?a='فایل "'+this.additionalData.fileName+'"، از حالت <span class="live-btn"><label dir="ltr">LIVE</label><i class="fa fa-circle"></i></span> خارج شد.':this.type===i.TYPE.LOADING&&(a='<div class="cssload-container"><div class="loading-text">در حال بارگذاری...</div></div>')}return a},i.prototype.isFromMe=function(){return this.senderId===g.member.id},i.prototype.isEnglish=function(){return!!this.body&&c.isEnglish(this.body)},i.prototype.isLoading=function(){return this.type===i.TYPE.LOADING},i.prototype.getStyle=function(){return this.isFile()||this.isEnglish()?{"text-align":"left",direction:"ltr"}:{}},i.prototype.getStatus=function(){return this.channel||(this.channel=d.findChannelById(this.channelId),this.channel)?this.isPending?i.STATUS_TYPE.PENDING:this.id<=this.channel.lastSeenId?i.STATUS_TYPE.SEEN:i.STATUS_TYPE.SENT:i.STATUS_TYPE.SEEN},i.prototype.getFileTimestampId=function(){return"file-"+this.fileTimestamp},i.prototype.getStatusIcon=function(){switch(this.getStatus()){case i.STATUS_TYPE.PENDING:return"zmdi zmdi-time";case i.STATUS_TYPE.SENT:return"zmdi zmdi-check";case i.STATUS_TYPE.SEEN:return"zmdi zmdi-check-all"}},i.prototype.getCssClass=function(){switch(this.type){case i.TYPE.TEXT:case i.TYPE.FILE:return this.isFromMe()?"msg msg-send":"msg msg-recieve";case i.TYPE.NOTIF.USER_ADDED:case i.TYPE.NOTIF.USER_REMOVED:case i.TYPE.NOTIF.FILE_LIVED:case i.TYPE.NOTIF.FILE_DIED:case i.TYPE.NOTIF.CHANNEL_CREATED:case i.TYPE.NOTIF.CHANNEL_EDITED:return"notif";case i.TYPE.LOADING:return"msg-loading"}},i.prototype.setIdAndDatetime=function(a,b){this._id=a,this.id=i.generateIntegerId(a),this.datetime=new Date(b)},i.prototype.setId=function(a){this.id=a},i.generateIntegerId=function(a){return parseInt(a.slice(a.lastIndexOf(":")+1,a.length))},i.prototype.getServerWellFormed=function(){var a={channelId:this.channelId,teamId:this.teamId,messageBody:this.body,type:this.type};return this.additionalData&&(a.additionalData=this.additionalData),this.about&&(a.about=this.about),a},i.prototype.getDbWellFormed=function(){var a={_id:this._id,id:this.id,body:this.body,senderId:this.senderId,channelId:this.channelId,datetime:this.datetime,type:this.type};return this.additionalData&&(a.additionalData=this.additionalData),this.about&&(a.about=this.about),a},i.prototype.save=function(){var c=this;b.getDb().then(function(b){b.put(c.getDbWellFormed()).catch(function(b){a.error("Saving message failed.",b)})})},i.generateMessageWellFormedText=function(a){var b=c.htmlToPlaintext(a);return b=c.htmlify(b)},i.prototype.isNotif=function(){return this.type===i.TYPE.NOTIF.USER_ADDED||this.type===i.TYPE.NOTIF.USER_REMOVED||this.type===i.TYPE.NOTIF.FILE_LIVED||this.type===i.TYPE.NOTIF.CHANNEL_CREATED||this.type===i.TYPE.NOTIF.CHANNEL_EDITED||this.type===i.TYPE.NOTIF.FILE_DIED},i.prototype.isFile=function(){return this.type===i.TYPE.FILE},i.prototype.getLocaleDate=function(){return f.getPersianDateString(this.datetime)},i.prototype.getLocaleTime=function(){return f.getPersianTime(this.datetime)},i.TYPE={TEXT:0,FILE:1,NOTIF:{USER_ADDED:2,USER_REMOVED:3,FILE_LIVED:4,CHANNEL_CREATED:5,CHANNEL_EDITED:6,FILE_DIED:7},LOADING:8},i.STATUS_TYPE={PENDING:0,SENT:1,SEEN:2},i}]),app.controller("messagesController",["$scope","$rootScope","$state","$stateParams","$window","$timeout","Message","messagesService","channelsService","filesService","$q","ArrayUtil","textUtil","CurrentMember","ngProgressFactory",function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o){function p(){f(function(){N.scrollTop=N.scrollHeight},0,!1)}function q(){N.scrollHeight-N.scrollTop<1.5*O.scrollHeight&&p()}function r(){B(a.channel.areAllMessagesHaveBeenSeen()?a.channel.memberLastSeenId:a.channel.memberLastSeenId+1)}function s(){b.isLoading=!1,b.$broadcast("loading:finished")}function t(){var c=k.defer();return M=a.channel.lastMessageId,a.channel.areAllMessagesHaveBeenSeen()||(L=a.channel.memberLastSeenId),b.$broadcast("channel:ready",a.channel),x().then(c.resolve()),a.inputMessage="",c.promise}function u(a){f(function(){var b=a.getFileTimestampId();a.uploadProgressBar=o.createInstance(),a.uploadProgressBar.setColor("#24A772"),a.uploadProgressBar.setParent(document.getElementById(b)),a.uploadProgressBar.setAbsolute(),a.uploadProgressBar.start(),a.uploadProgressBar.set(2)},0,!1)}function v(b,c,d,e){h.getMessagesRangeFromServer(b,n.member.teamId,c,d).then(function(b){A(c),b.forEach(function(b){l.containsKeyValue(a.messages,"id",b.id)||a.messages.push(b)}),J=!1,F(e)})}function w(){var b=k.defer(),c=d.slug?d.slug.replace("@",""):null;return i.setCurrentChannelBySlug(c).then(function(){a.channel=i.getCurrentChannel(),b.resolve()}),b.promise}function x(){var b=k.defer();return h.getMessagesByChannelId(a.channel.id,a.channel.lastMessageId).then(function(c){if(a.messages=c,r(),a.channel.hasUnread()){var d=l.getElementByKeyValue(a.messages,"id",a.channel.lastMessageId);h.seenMessage(a.channel.id,d.id,d.senderId),f(function(){H()||(Q=!0),a.$apply()})}b.resolve()}),b.promise}function y(){I.lastUnSeenMessage&&(h.seenMessage(a.channel.id,I.lastUnSeenMessage.id,I.lastUnSeenMessage.senderId),I.lastUnSeenMessage=null)}function z(){a.inputMessage=""}function A(b){l.removeElementByKeyValue(a.messages,"id",b)}function B(a){f(function(){var b=E(a);b&&(N.scrollTop=b.offsetTop-O.offsetTop)},0,!1)}function C(a,b){return b?a.offsetTop>N.scrollTop&&a.offsetTop<N.scrollTop+N.scrollHeight:a.offsetTop>N.scrollTop+O.scrollHeight&&a.offsetTop<N.scrollTop+2*O.scrollHeight}function D(){return a.messages.filter(function(a){return a.isLoading()})}function E(a){return document.getElementById("message_"+a)}function F(a){D().forEach(function(b){C(E(b.id),a)&&!J&&(v(b.additionalData.channelId,b.additionalData.from,b.additionalData.to,a),J=!0)})}function G(){a.hasUnreadNewMessages=a.hasUnreadNewMessages&&!H(),Q=Q&&!H()}function H(){return N.scrollTop+O.scrollHeight>N.scrollHeight}var I=this;a.messages=[],a.hasUnreadNewMessages=!1;var J,K,L,M,N=document.getElementById("messagesHolder"),O=document.getElementById("messagesWindow"),P=!1,Q=!1;if(a.$on("channels:updated",function(b,c){"init"===c&&w().then(function(){a.channel?a.channel.initialMessagesPromise.then(function(){return t()}).then(function(){s()}):s()})}),!d.slug)return void i.setCurrentChannelBySlug(null);i.areChannelsReady()&&w().then(function(){a.channel.initialMessagesPromise.then(t())}),a.$on("type:start",function(b,c){a.channel.id===c&&q()}),a.$on("message",function(c,d){a.channel.id==d.channelId&&(H()||(a.hasUnreadNewMessages=!0,f(function(){a.$apply()})),b.isTabFocused?(a.channel.seenLastMessage(),h.seenMessage(a.channel.id,d.id,d.senderId)):I.lastUnSeenMessage=d,a.messages.push(d),d.isFile()&&j.createFileManagerFile(d.additionalData.fileId,d.additionalData.url,d.additionalData.name,d.datetime,d.additionalData.type),q())}),a.$on("file:uploading",function(b,c){a.uploadErrNotif=!1;var d=h.sendFileAndGetMessage(a.channel.id,c,c.name);a.messages.push(d),p(),u(d)}),a.$on("file:uploadError",function(){I.uploadErrNotifTimeout&&f.cancel(I.uploadErrNotifTimeout),a.uploadErrNotif||(a.uploadErrNotif=!0),I.uploadErrNotifTimeout=f(function(){a.uploadErrNotif=!1},3e3)}),a.upload=function(a,c){b.$broadcast("file:upload",a,c)},a.getInputStyle=function(){return m.isEnglish(a.inputMessage)?{"text-align":"left",direction:"ltr"}:{}},a.sendMessage=function(b){b.preventDefault();var c=a.inputMessage.trim();if(c){a.channel.seenLastMessage();var d=h.sendAndGetMessage(a.channel.id,c);a.messages.push(d),p(),z(),h.endTyping(a.channel.id),f.cancel(I.isTypingTimeout),I.isTyping=!1}},a.typing=function(){I.isTypingTimeout&&f.cancel(I.isTypingTimeout),I.isTyping||(I.isTyping=!0,h.startTyping(a.channel.id)),I.isTypingTimeout=f(function(){I.isTyping=!1,h.endTyping(a.channel.id)},2e3)},a.showFileLine=function(a,b,c){j.showFileLine(a,b,c)},a.navigateToAndWaitFor=function(){c.go("messenger.home")},a.shouldShowJumpDownButton=function(){return P||a.hasUnreadNewMessages||Q},a.jumpDown=function(){J=!0,B(a.channel.lastMessageId),J=!1},a.isMessageDateInAnotherDay=function(b){if(1===b.id)return!0;var c=l.getElementByKeyValue(a.messages,"id",b.id-1);if(c){var d=Math.abs(b.datetime.getTime()-c.datetime.getTime());return 0!==Math.floor(d/864e5)}},a.goLive=function(b,c){j.makeFileLive(a.channel.id,b,c)},a.viewFile=function(a){j.viewFile(a)},a.archiveDirect=function(b){i.archiveChannel(b.id).then(function(){a.removeAndCloseChannel(b)}).catch(function(){})},a.removeAndCloseChannel=function(a){i.removeChannel(a.id),c.go("messenger.home")},a.joinPublicChannel=function(){i.addMembersToChannel([n.member.id],a.channel.id),a.channel.isCurrentMemberChannelMember=!0},a.isMessageFirstUnread=function(a){return!!M&&a.id===L+1},document.getElementById("inputPlaceHolder").focus(),angular.element(N).bind("scroll",function(){var b,c=N.scrollTop;K&&(b=K>c),K=c,P=!H()&&!1===b,F(b),G(),a.$apply()}),document.onkeydown=function(a){a=a||e.event,27==a.keyCode&&c.go("messenger.home")},a.$on("tab:focus:changed",function(){b.isTabFocused&&y()})}]),app.service("messagesService",["$rootScope","$http","$log","$q","socket","channelsService","Message","db","filesService","CurrentMember","Team","ArrayUtil","FileManagerFile",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(a){var b=(d.defer(),o(a.memberLastSeenId,a.lastMessageId)),c=b.map(function(b){return z(a.id,a.teamId,b.from,b.to)});return d.all(c)}function o(a,b){if(!b)return[];var c=Math.max(a-H/4+1,1),d=Math.min(a+3*H/4,b);return 1===c&&(d=Math.min(H,b)),d===b&&(c=Math.max(b-H+1,1)),p(b,c,d)}function p(a,b,c){var d=[];return c<a-H?(d.push({from:b,to:c}),d.push({from:a-H+1,to:a})):d.push({from:b,to:a}),d}function q(a){var b=d.defer();return h.getDb().then(function(d){d.bulkDocs(a).then(function(){b.resolve()}).catch(function(a){b.reject(),c.error("Bulk saving messages failed.",a)})}),b.promise}function r(a,b,c,f){var h=d.defer(),i={channelId:a,teamId:b,from:c,to:f};return e.emit("message:get",i,function(a){var b=a.messages.map(function(a){return new g(a.body,a.type,a.senderId,a.channelId,a.id,a.datetime,a.additionalData,a.about)});h.resolve(b),q(b.map(function(a){return a.getDbWellFormed()}))}),h.promise}function s(a,b){var c=d.defer();return y(a).then(function(d){var e=d.docs.map(function(a){return new g(a.body,a.type,a.senderId,a.channelId,a._id,a.datetime,a.additionalData,a.about)});t(e,a,b),c.resolve(e)}),c.promise}function t(a,b,c){if(a.length>0){var d=a[0].id,e=a[a.length-1].id;u(a,b),v(a,b,d),w(a,b,c,e)}else v(a,b,c)}function u(a,b){for(var c=0;c<a.length;c++)c!==a.length-1&&a[c+1].id-a[c].id>1&&x(a,b,a[c].id+1,a[c+1].id-1)}function v(a,b,c){for(var d=c-1,e=c-1;e>0;e--)(d-e>=H-1||1===e)&&(x(a,b,e,d),d=e-1)}function w(a,b,c,d){for(var e=d+1,f=d+1;f<=c;f++)(f-e>=H-1||f===c-1)&&(x(a,b,e,f),e=f+1)}function x(a,b,c,d){var e={channelId:b,from:c,to:d};if(d-c<H){var f=new g(null,g.TYPE.LOADING,null,b,null,null,e,null,null);f.setId(c),a.push(f)}else x(a,b,c,c+H-1),x(a,b,c+H,d)}function y(a){var b=d.defer();return h.getDb().then(function(c){c.find({selector:{id:{$gt:null},channelId:{$eq:a}},sort:[{id:"asc"}]}).then(function(a){b.resolve(a)})}),b.promise}function z(a,b,c,e){return A(a,c,e).then(function(f){var g=B(f,c,e);if(g.length){var h=g.map(function(c){return r(a,b,c.from,c.to)});return d.all(h)}})}function A(a,b,c){var e=d.defer();return h.getDb().then(function(d){d.find({selector:{id:{$gt:b-1,$lt:c+1},channelId:{$eq:a}},fields:["id"],sort:[{id:"asc"}]}).then(function(a){e.resolve(a.docs)})}),e.promise}function B(a,b,c){for(var d=[],e=0,f=b;f<=c;f++){if(!a[f-b-e]){d.push({from:f,to:c});break}if(f!==a[f-b-e].id){d.push({from:f,to:a[f-b-e].id-1});var g=a[f-b-e].id-f;f=a[f-b-e],e+=g}}return d}function C(a,b,c,d,h){var k=null,l=null;d&&(k={name:d,url:h});var m=i.getLivedFile();if(m){var n=m.getTempLines();n&&(l={fileId:m.id,lineNumber:n.start,lineNumberTo:n.end}),m.deselectTempLines()}var o=new g(b,c||g.TYPE.TEXT,j.member.id,a,null,null,k,l,!0);return e.emit("message:send",o.getServerWellFormed(),function(a){o.isPending=!1,o.setIdAndDatetime(a.id,a.datetime,a.additionalData),o.save(),f.updateChannelLastDatetime(o.channelId,o.datetime)}),o}function D(a,b,d){var h={name:d},k=new g(null,g.TYPE.FILE,j.member.id,a,null,null,h,null,!0,+new Date);return i.uploadFile(d,a,j.member.id,b,k).then(function(a){k.additionalData.url=a.data.file,k.additionalData.fileId=a.data.id,k.additionalData.type=a.data.type,e.emit("message:send",k.getServerWellFormed(),function(a){k.isPending=!1,k.setIdAndDatetime(a.id,a.datetime,a.additionalData),k.save(),f.updateChannelLastDatetime(k.channelId,k.datetime)}),i.createFileManagerFile(a.data.id,a.data.file,a.data.name,a.data.date_uploaded,a.data.type)}).catch(function(a){c.error("Error Uploading File.",a)}),k}function E(a,b,c){var d={channelId:a,teamId:f.getCurrentChannel().teamId,messageId:b,senderId:c};e.emit("message:seen",d),f.updateChannelNotification(a,"empty")}function F(a){var b={channelId:a};e.emit("message:type:start",b)}function G(a){var b={channelId:a};e.emit("message:type:end",b)}var H=20;return e.on("message:send",function(b){var c=new g(b.body,b.type,b.senderId,b.channelId,b.id,b.datetime,b.additionalData,b.about);if(c.save(),c.type===g.TYPE.NOTIF){var d=f.findChannelById(c.channelId);c.type===g.TYPE.NOTIF.USER_ADDED?d.membersCount=d.membersCount+c.additionalData.length:c.type===g.TYPE.NOTIF.USER_REMOVED&&d.membersCount--}a.$broadcast("message",c),f.updateChannelLastDatetime(c.channelId,c.datetime),c.about&&i.showFileLine(c.about.fileId,c.about.lineNumber,c.about.lineNumberTo)}),e.on("message:type:start",function(b){f.addIsTypingMemberByChannelId(b.channelId,b.memberId),a.$broadcast("channels:updated"),a.$broadcast("type:start",b.channelId)}),e.on("message:type:end",function(b){f.removeIsTypingMemberByChannelId(b.channelId,b.memberId),a.$broadcast("channels:updated")}),e.on("message:seen",function(a){f.updateChannelLastSeen(a.channelId,a.messageId)}),a.$on("channel:new",function(a,b){var c;if(b.isDirect()&&b.isFakeDirect){var e=d.defer();e.resolve(),c=e.promise}else c=n(b);b.setInitialMessagesPromise(c),f.addMessagesPromise(c)}),{getMessagesByChannelId:s,sendAndGetMessage:C,sendFileAndGetMessage:D,getMessagesRangeFromServer:r,seenMessage:E,startTyping:F,endTyping:G}}]),app.controller("filesController",["$window","filesService","Upload","$scope","$timeout","$rootScope",function(a,b,c,d,e,f){function g(){f.$broadcast("view:state:changed",d.viewState())}function h(a,b,c){var f;f="live"===d.viewState()?document.getElementById("liveCodeView"):document.getElementById("codeView"),e(function(){var d;d=Math.abs(b,c)<30?Math.ceil((b+c)/2):b;var e=(d-17)/a.lines.length*f.scrollHeight;f.scrollTop=e},0,!1)}d.vm={};var i,j=!1,k=!1;d.fileLoading=!1,d.isViewedFileClicked=!1;var l="none";b.updateLiveFile(),d.$on("channel:ready",function(a,b){d.channel=b}),d.$on("file:loading",function(){d.fileLoading=!0});var m=this;d.$on("file:ready",function(){d.fileLoading=!1}),d.$on("channels:updated",function(a,c){"init"===c&&b.updateLiveFile()}),d.$on("file:lived",function(a,b){l="live",d.vm.viewFile&&b.id===d.vm.viewFile.id&&(d.vm.viewFile=null),d.vm.liveFile=b,g()}),d.$on("file:killed",function(){l="view",d.vm.liveFile=null,g()}),d.$on("file:view",function(a,b){l="view",d.vm.viewFile=b,g()}),d.$on("file:show:line",function(a,b,c,e){b===d.vm.liveFile?(l="live",b.selectPermLines(c,e),h(b,c,e)):b===d.vm.viewFile?(l="view",b.selectPermLines(c,e),h(b,c,e)):(l="view",n(b),b.selectPermLines(c,e),h(b,c,e)),g()}),d.$on("file:upload",function(a,b,c){b&&f.$broadcast("file:uploading",b),!b&&c[0]&&f.$broadcast("file:uploadError")}),d.showViewedFileClickedWarning=function(){m.viewClickTimeout&&e.cancel(m.viewClickTimeout),d.viewClickNotif||(d.viewClickNotif=!0),m.viewClickTimeout=e(function(){d.viewClickNotif=!1},3e3)},d.mouseDownLine=function(a){j=!0,d.vm.liveFile.isLineTemp(a)&&(k=!0,d.vm.liveFile.deselectTempLines()),i=a,d.vm.liveFile.selectTempLines("start",a),d.vm.liveFile.selectTempLines("end",a)},d.mouseUpLine=function(a){k&&i===a&&(d.vm.liveFile.deselectTempLines(),k=!1),j=!1,document.getElementById("inputPlaceHolder").focus()},d.mouseOverLine=function(a){if(j){var b=Math.min(i,a),c=Math.max(i,a);d.vm.liveFile.selectTempLines("start",b),d.vm.liveFile.selectTempLines("end",c)}};var n=function(a){b.viewFile(a.id,a.name)};d.closeLiveFile=function(){d.vm.liveFile.deselectTempLines(),b.killLiveFile(d.vm.liveFile),d.vm.liveFile=null,g()},d.closeViewFile=function(){l="live",d.vm.viewFile=null,g()},d.liveFileTabClick=function(){l="live",g()},d.viewFileTabClick=function(){l="view",g()},d.viewState=function(){return d.vm.liveFile||d.vm.viewFile?"live"===l?"live":"view":"noFile"},d.upload=function(a,b){f.$broadcast("file:upload",a,b)},d.getFileDownloadData=function(a){return"live"===d.viewState()&&d.vm.liveFile?"url"===a?d.vm.liveFile.url:d.vm.liveFile.name:"view"===d.viewState()&&d.vm.viewFile?"url"===a?d.vm.viewFile.url:d.vm.viewFile.name:void 0},d.makeViewFileLive=function(){var a=d.vm.viewFile;b.makeFileLive(a.channelId,a.id,a.name)},g()}]),app.controller("fileManagerController",["$scope","filesService","channelsService","FileManagerFile","$state","Fullscreen",function(a,b,c,d,e,f){a.files=[],a.fileManagerFilterType=null;var g=!1,h=!0,i=!0;a.$on("channel:changed",function(){a.channel=c.getCurrentChannel()}),a.$on("file:newFileManagerFile",function(b,c){a.files.push(c)}),a.getFileManagerClass=function(){return h?"mime-holder closed":"mime-holder opened"},a.toggleFileManagerStatus=function(){i?(g=!0,b.getFileManagerFiles(a.channel.id).then(function(b){a.files=b,i=!1,g=!1,h=!1})):h=!h},a.getFileManagerToggleClass=function(){return g?"fa fa-spinner":"mime-menu-toggle"},a.doesChannelHaveAnyFilteredFiles=function(){return null===a.fileManagerFilterType?0!==a.files.length:0!==a.files.filter(function(b){return b.type===a.fileManagerFilterType}).length},a.shouldShowInFileManager=function(b){return!a.fileManagerFilterType||a.fileManagerFilterType===b.type},a.getMessageOfNoFilteredFile=function(){switch(parseInt(a.fileManagerFilterType)){case null:return"هیچ فایلی وجود ندارد";case d.TYPE.CODE:return"هیچ فایلی به صورت کد وحود ندارد";case d.TYPE.PICTURE:return"هیچ عکسی وجود ندارد";case d.TYPE.DOCUMENT:return"هیچ سندی وجود ندارد";case d.TYPE.OTHER:return"هیچ فایل دیگری وحود ندارد"}},a.goLive=function(c,d){b.makeFileLive(a.channel.id,c,d)},a.viewFile=function(a){b.viewFile(a)},a.fullscreenPhoto=function(a){var b="img-"+a;f.enable(document.getElementById(b))},a.navigateToHome=function(){e.go("messenger.home")}}]),app.service("filesService",["$rootScope","$http","$log","socket","ArrayUtil","$q","channelsService","File","FileManagerFile","fileUtil","Upload",function(a,b,c,d,e,f,g,h,i,j,k){function l(){var b=g.getCurrentChannel();b&&(b.liveFileId?n(b.liveFileId).then(function(b){a.$broadcast("file:lived",b),y.livedFile=b}):(y.livedFile=null,a.$broadcast("file:killed")))}function m(a){return b({method:"GET",url:a})}function n(d){var g=f.defer(),i=e.getElementByKeyValue(y.files,"id",d);if(i)g.resolve(i);else{a.$broadcast("file:loading");var k,l,n,o;b({method:"GET",url:"/api/v1/files/"+d+"/"}).then(function(a){return k=a.data.file,l=a.data.name,n=a.data.type,o=a.data.channel,m(k)}).then(function(b){if(j.isTextFormat(n)){var e=new h(d,k,b.data,l,o);y.files.push(e),a.$broadcast("file:ready"),g.resolve(e)}else c.error("Lived File Format Not Supported Yet !"),a.$broadcast("file:ready"),g.reject()}).catch(function(b){c.error("Error Getting File name and URL From Server.",b),a.$broadcast("file:ready"),g.reject()})}return g.promise}function o(a,b,c,d,e){var g=f.defer();return z.push({fileName:a,channelId:b,memberId:c,fileData:d,message:e,deferred:g}),1===z.length&&p(),g.promise}function p(){var a=z[0];k.upload({url:"api/v1/files/upload/"+a.fileName,data:{name:a.fileName,channel:a.channelId,sender:a.memberId,file:a.fileData},method:"PUT"}).then(function(b){a.deferred.resolve(b)},function(b){c.error("Error status: "+b.status),a.deferred.reject()},function(b){var c=parseInt(100*b.loaded/b.total);100===c?a.message.uploadProgressBar.complete():a.message.uploadProgressBar.set(c)}).finally(function(){z.shift(),z.length>0&&p()})}function q(a){var d=f.defer();return b({method:"GET",url:"/api/v1/files/channels/"+a+"/"}).then(function(a){var b=a.data.map(function(a){return new i(a.id,a.file,a.name,a.date_uploaded,a.type)});d.resolve(b)}).catch(function(a){c.info("Error Getting FileManager Files.",a),d.reject(a)}),d.promise}function r(b){y.livedFile&&y.livedFile.id===b?l():n(b).then(function(b){a.$broadcast("file:view",b)})}function s(a,b,c){u("makeLive",a,c,b)}function t(a){u("kill",a.channelId,a.name)}function u(a,b,c,e){var f={channelId:b,fileName:c};"makeLive"===a?f.fileId=e:"kill"===a&&(f.fileId=null),d.emit("file:lived",f)}function v(){return y.livedFile}function w(b,c,d,e,f){var g=new i(b,g,d,e,f);a.$broadcast("file:newFileManagerFile",g)}function x(b,c,d){n(b).then(function(b){a.$broadcast("file:show:line",b,c,d)})}var y=this,z=[];return y.files=[],y.viewFile=null,d.on("file:lived",function(a){g.setChannelLivedFileId(a.channelId,a.fileId),l()}),{makeFileLive:s,killLiveFile:t,updateLiveFile:l,getLivedFile:v,showFileLine:x,getFileById:n,uploadFile:o,getFileManagerFiles:q,viewFile:r,createFileManagerFile:w}}]),app.factory("File",["$window","Line","fileUtil","$timeout",function(a,b,c,d){function e(a,b,c,d,e){
this.id=a,this.url=b,this.name=d,this.channelId=e,this.lines=f(c,this),this.isTempSelected=!1,this.isPermSelected=!1}function f(c,d){var e=[],f=a.PR.prettyPrintOne(c,"",!0),g=document.createElement("html");g.innerHTML=f;for(var h=g.getElementsByTagName("li"),i=0;i<h.length;i++){var j=h[i],k=new b(i+1,j.innerHTML,d);e.push(k)}return e}return e.prototype.selectTempLines=function(a,b){this.isTempSelected=!0,"start"===a?this.tempStartLine=b:"end"===a&&(this.tempEndLine=b)},e.prototype.deselectTempLines=function(){this.isTempSelected=!1,this.tempStartLine=null,this.tempEndLine=null},e.prototype.selectPermLines=function(a,b){this.isPermSelected=!0,this.permStartLine=a,this.permEndLine=b;var c=this;this.permTimeout&&d.cancel(this.permTimeout),this.permTimeout=d(function(){c.isPermSelected=!1},2e3)},e.prototype.getLine=function(a){return this.lines[a-1]},e.prototype.getTempLines=function(){return this.isTempSelected?this.findStartAndEndTempLines(this):null},e.prototype.findStartAndEndTempLines=function(){return{start:Math.min(this.tempStartLine,this.tempEndLine),end:Math.max(this.tempStartLine,this.tempEndLine)}},e.prototype.isLineTemp=function(a){if(this.isTempSelected){var b=this.findStartAndEndTempLines();return a>=b.start&&a<=b.end}return!1},e}]),app.factory("Line",[function(){function a(a,b,c){this.num=a,this.html=b,this.file=c}return a.prototype.getCssClass=function(){if(this.file.isTempSelected){if(this.num>=this.file.tempStartLine&&this.num<=this.file.tempEndLine)return"line-temp-selected"}else if(this.file.isPermSelected&&this.num>=this.file.permStartLine&&this.num<=this.file.permEndLine)return"line-perm-selected"},a.SELECT_TYPE={TEMPORARY:0,PERMENANT:1},a}]),app.factory("FileManagerFile",["dateUtil","fileUtil",function(a,b){function c(a,b,c,d,e){this.id=a,this.url=b,this.name=c,this.date=new Date(d),this.extension=e,this.type=this.getFileType(),this.svg=this.getSvgUrl()}return c.prototype.getSvgUrl=function(){return"/static/img/file-formats.svg#"+this.extension},c.prototype.getFileName=function(){return this.name.replace("."+this.extension,"")},c.prototype.canBeLived=function(){return b.isTextFormat(this.extension)},c.prototype.isPhoto=function(){return b.isPictureFormat(this.extension)},c.prototype.getLocalDate=function(){return a.getPersianDateString(this.date)},c.prototype.getFileType=function(){return b.fileManagerFileFormat(this.extension)},c.prototype.downloadFile=function(){var a=document.createElement("a");a.download=this.name,a.href=this.url,a.click()},c.TYPE={CODE:1,PICTURE:2,DOCUMENT:3,OTHER:4},c}]),app.controller("userProfileController",["$scope","$window","CurrentMember","AuthService","profileService","$uibModalInstance","$timeout",function(a,b,c,d,e,f,g){function h(b,c){switch(b){case"info":a.infoMessage=c,a.showInfoMessage=!0,g(function(){a.showInfoMessage=!1,a.infoMessage=null},5e3);break;case"error":a.showErrorMessage=!0,a.errorMessage=c,g(function(){a.showErrorMessage=!1,a.errorMessage=null},5e3)}}function i(){a.oldPasswordInput="",a.newPasswordInput="",a.confirmPasswordInput=""}!function(){a.user=c.member.user,a.usernameInput="",a.editUsernameActive=!1,a.changePasswordActive=!1,a.showErrorMessage=!1,a.showInfoMessage=!1}(),a.editUsername=function(){a.editUsernameActive=!0},a.changePassword=function(){i(),a.changePasswordActive=!0},a.savePassword=function(){a.newPasswordInput!==a.confirmPasswordInput?h("error","رمز عبور با تکرار آن مطابقت ندارد."):(a.changePasswordActive=!1,e.changePassword(a.oldPasswordInput,a.newPasswordInput,a.confirmPasswordInput).then(function(a){h("info",a)}).catch(function(a){h("error",a)}))},a.saveUsername=function(){""===a.usernameInput?h("error","نام کاربری نباید خالی باشد."):a.usernameInput.length>16?h("error","نام کاربری حداکثر می تواند ۱۶ کاراکتر باشد."):e.changeUsername(a.usernameInput).then(function(b){a.user.username=a.usernameInput,h("info",b),a.editUsernameActive=!1}).catch(function(b){h("error",b),a.usernameInput=""})},a.uploadProfileImage=function(a,b){a&&e.changeProfileImage(a).then(function(a){h("info",a)}).catch(function(a){h("error",a)})},a.leaveTeam=function(){e.removeTeamMember().then(function(){return d.logout()}).then(function(){b.location.href="/login"})}}]),app.controller("teamProfileController",["$scope","$log","profileService","$uibModalInstance","CurrentMember","Team","$timeout","validationUtil","ArrayUtil","teamService","channelsService","uiTourService","tourClicked",function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(b,c){switch(b){case"info":a.infoMessage=c,a.showInfoMessage=!0,g(function(){a.showInfoMessage=!1,a.infoMessage=null},4e3);break;case"error":a.showErrorMessage=!0,a.errorMessage=c,g(function(){a.showErrorMessage=!1,a.errorMessage=null},4e3)}}function o(){a.invitedEmail="",a.forms.inviteMember.$setPristine()}!function(){a.teamMembers=f.getActiveMembers(),a.team=f,a.editTeamNameActive=!1,a.inviteMode=!1,a.forms={}}(),a.$on("members:updated",function(){a.teamMembers=f.getActiveMembers()}),a.inviteMember=function(){o(),a.inviteMode=!0},a.sendInvitation=function(){a.invitedEmail?h.validateEmail(a.invitedEmail)?c.sendInvitationEmail(a.invitedEmail).then(function(){a.invitedEmail="",n("info","ایمیل دعوت به تیم با موفقیت ارسال شد."),a.inviteMode=!1}).catch(function(a){b.error("Invitation Error:",a),a.data&&"Email already a member."===a.data[0]?n("error","فرد مورد نظرت در حال حاضر عضو تیمه"):a.data&&"Email already has an active invitaion."===a.data[0]?n("error","ایمیل فعال سازی ارسال شده است."):n("error","خطا در دعوت به تیم")}):n("error","ایمیل وارد شده معتبر نیست"):n("error","لطفا ایمیل رو وارد کن.")},a.editTeamName=function(){a.editTeamNameActive=!0},a.saveTeamName=function(){a.editTeamNameActive=!1},a.removeTeamMember=function(a){c.removeTeamMember(a)},a.changeMemberAdminState=function(a){!1===a.isAdmin?c.makeAdmin(a).then(function(){a.isAdmin=!0}).catch(function(a){b.error("Error Making Member Admin:",a)}):c.disAdmin(a).then(function(){a.isAdmin=!1}).catch(function(a){b.error("Error DisAdmining Member:",a)})},a.getAdminButtonCSS=function(a){return a.isAdmin?"is-admin":""},a.onTourReady=function(a){m&&g(function(){a.start()},500)},a.isMe=function(a){return a.id===e.member.id}}]),app.service("profileService",["$log","Upload","$http","$q","socket","ArrayUtil","AuthService","$localStorage","CurrentMember","Team",function(a,b,c,d,e,f,g,h,i,j){function k(b){var e=d.defer();return c({method:"PATCH",url:"/api/v1/auth/users/"+i.member.user.id+"/username/change/",data:{username:b}}).then(function(a){h.token=a.token,i.username=b,f.getElementByKeyValue(j.getActiveMembers(),"id",i.member.id).username=b,g.initialize(),e.resolve("نام کاربری با موفقیت تغییر کرد.")}).catch(function(b){a.error("Error Changing Username",b),b.username?f.contains(b.username,"This field may not be blank.")?e.reject("نام کاربری نباید خالی باشد."):f.contains(b.username,"A user with that username already exists.")?e.reject("این نام کاربری قبلا انتخاب شده است."):f.contains(b.username,"Enter a valid username. This value may contain only letters, numbers, and @/./+/-/_ characters.")?e.reject("نام کاربری معتبر نیست، این نام تنها می تواند شامل حروف، اعداد و بعضی از علامت ها باشد."):e.reject("خطا در تغییر نام کاربری"):e.reject("خطا در تغییر نام کاربری")}),e.promise}function l(b,e,f){var g=d.defer();return c({method:"POST",url:"/api/v1/auth/password/change/",data:{old_password:b,new_password1:e,new_password2:f}}).then(function(a){g.resolve("رمز عبور با موفقیت تغییر کرد.")}).catch(function(b){a.error("Error Changing Password",b),g.reject("خطا در تغییر رمز عبور")}),g.promise}function m(c){var e=d.defer();return b.upload({url:"/api/v1/auth/users/"+i.member.user.id+"/image/change/",data:{image:c},method:"PATCH"}).then(function(a){i.member.image=a.data.image,e.resolve("عکس پروفایل با موفقیت تغییر کرد.")}).catch(function(b){a.error("Error Changing Profile Image",b),e.reject("خطا در تغییر عکس پروفایل")}),e.promise}function n(b){var c=d.defer(),f={memberId:b?b.id:i.member.id};return e.emit("member:remove",f,function(b){b.status?c.resolve():(a.error("Error :",b.message),c.reject())}),c.promise}function o(b){var e=d.defer();return c({method:"POST",url:"/api/v1/teams/"+j.id+"/member/"+b.id+"/admin/"}).then(function(){e.resolve()}).catch(function(b){a.error("Error Making Admin",b),e.reject()}),e.promise}function p(b){var e=d.defer();return c({method:"POST",url:"/api/v1/teams/"+j.id+"/member/"+b.id+"/disadmin/"}).then(function(){e.resolve()}).catch(function(b){a.error("Error deAdmining",b),e.reject()}),e.promise}function q(a){return c({method:"POST",url:"/api/v1/teams/"+j.id+"/invite/send/",data:{email:a}})}return{changeUsername:k,changePassword:l,changeProfileImage:m,removeTeamMember:n,makeAdmin:o,disAdmin:p,sendInvitationEmail:q}}]);